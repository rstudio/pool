<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced usage • pool</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced usage">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pool</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.3.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/why-pool.html">Why pool?</a></li>
    <li><a class="dropdown-item" href="../articles/pool-dplyr.html">Using pool with dplyr</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-pool.html">Advanced usage</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rstudio/pool/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced usage</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/pool/blob/main/vignettes/articles/advanced-pool.Rmd" class="external-link"><code>vignettes/articles/advanced-pool.Rmd</code></a></small>
      <div class="d-none name"><code>advanced-pool.Rmd</code></div>
    </div>

    
    
<p>This article discusses some more advanced features of the pool
package, namely customizing your pool and using pool with database
transactions.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/pool" class="external-link">pool</a></span><span class="op">)</span></span></code></pre></div>
<p>Get started by installing the packages you need:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shiny"</span>, <span class="st">"DBI"</span>, <span class="st">"pool"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="customizing-your-pool">Customizing your pool<a class="anchor" aria-label="anchor" href="#customizing-your-pool"></a>
</h2>
<p>First, let’s get to know our Pool object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/pool" class="external-link">pool</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pool</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbPool.html">dbPool</a></span><span class="op">(</span></span>
<span>  drv <span class="op">=</span> <span class="fu">RMySQL</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RMySQL/man/MySQLDriver-class.html" class="external-link">MySQL</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  dbname <span class="op">=</span> <span class="st">"shinydemo"</span>,</span>
<span>  host <span class="op">=</span> <span class="st">"shiny-demo.csa7qlmguqrf.us-east-1.rds.amazonaws.com"</span>,</span>
<span>  username <span class="op">=</span> <span class="st">"guest"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"guest"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pool</span></span>
<span><span class="co">#&gt; &lt;Pool&gt; of MySQLConnection objects</span></span>
<span><span class="co">#&gt;   Objects checked out: 0</span></span>
<span><span class="co">#&gt;   Available in pool: 1</span></span>
<span><span class="co">#&gt;   Max size: Inf</span></span>
<span><span class="co">#&gt;   Valid: TRUE</span></span></code></pre></div>
<p>As you can see, printing gives you basic information about your pool.
This can be useful to learn how many connections you have open (both
free/idle and in use).</p>
<p>But for this section, let’s turn our attention to other parameters
that you can pass to <code><a href="../reference/dbPool.html">dbPool()</a></code>: <code>minSize</code>,
<code>maxSize</code>, and <code>idleTimeout</code>.</p>
<p>When created, the pool will initialize <code>minSize</code>
connections, and keeps them around until they’re requested. If all the
idle connections are taken up when another request for a connection
comes up, the pool will create a new connection. It’ll keep doing this
as needed until it gets to <code>maxSize</code> connections at which
point it will error.</p>
<p>Any connection that is created when we’re over <code>minSize</code>
will have a timer attached to it: from the moment it is returned back to
the pool, a countdown of <code>idleTimeout</code> seconds will start. If
that connection is not requested again during that period, it will be
destroyed when the countdown finishes. If it <em>is</em> requested and
checked out of the pool, the countdown will the reset when it is
returned back to the pool.</p>
<p>The optimal values of these three parameters depend on how you’re
using your pool, as they represent a tradeoff between how adaptable your
pool is and how efficient it is. Large values for all three parameters
would mean that your pool is highly adaptable (it can handle spikes in
traffic easily), but potentially not very efficient (it might be
creating and holding on to connections that aren’t needed). On the other
hand, small values for these parameters would mean that your pool is
very strict about the number of connections it has (it will very rarely
allow for idle connections) which will lead to an efficient pool if
traffic is consistent. However, this type of pool won’t be able to
handle spikes in traffic easily: on one hand, it will often have to do
the computationally expensive fetching of connections directly from the
database, since it doesn’t hold on to idle connections for long; on the
other hand, once it hits the <code>maxSize</code> number of connections,
it won’t be able to scale up any further.</p>
<p>Considering where your pool falls on this spectrum, you should choose
the value for these arguments accordingly. For example, if you want a
stable pool that will adapt and scale up easily (and you’re not too
worried about efficiency), you could do something like:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/pool" class="external-link">pool</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">pool</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbPool.html">dbPool</a></span><span class="op">(</span></span>
<span>  drv <span class="op">=</span> <span class="fu">RMySQL</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RMySQL/man/MySQLDriver-class.html" class="external-link">MySQL</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  dbname <span class="op">=</span> <span class="st">"shinydemo"</span>,</span>
<span>  host <span class="op">=</span> <span class="st">"shiny-demo.csa7qlmguqrf.us-east-1.rds.amazonaws.com"</span>,</span>
<span>  username <span class="op">=</span> <span class="st">"guest"</span>,</span>
<span>  password <span class="op">=</span> <span class="st">"guest"</span>,</span>
<span>  minSize <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  idleTimeout <span class="op">=</span> <span class="fl">60</span> <span class="op">*</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/Pool-class.html">poolClose</a></span><span class="op">(</span><span class="va">pool</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="transactions">Transactions<a class="anchor" aria-label="anchor" href="#transactions"></a>
</h2>
<p>So far, we’ve recommended you always use the pool object directly
when you need to query the database. There’s one challenge where this is
not possible: transactions. Because for a transaction, you need to have
access to the same connection for longer than a single query. The
following will not necessary work because the pool might give you a
different connection for each</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dbi.r-dbi.org/reference/transactions.html" class="external-link">dbBegin</a></span><span class="op">(</span><span class="va">pool</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">pool</span>, <span class="va">A</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">pool</span>, <span class="va">B</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dbi.r-dbi.org/reference/transactions.html" class="external-link">dbCommit</a></span><span class="op">(</span><span class="va">pool</span><span class="op">)</span></span></code></pre></div>
<p>DBI provides a helper for this case, but it doesn’t work either:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbWithTransaction.html" class="external-link">dbWithTransaction</a></span><span class="op">(</span><span class="va">pool</span>, <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">pool</span>, <span class="va">A</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">pool</span>, <span class="va">B</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>You can instead use <code><a href="../reference/poolWithTransaction.html">pool::poolWithTransaction()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pool</span><span class="fu">::</span><span class="fu"><a href="../reference/poolWithTransaction.html">poolWithTransaction</a></span><span class="op">(</span><span class="va">pool</span>, <span class="kw">function</span><span class="op">(</span><span class="va">con</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">A</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">B</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by Joe Cheng, Barbara Borges, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

  </div></footer>
</body>
</html>
